---
title: "Co-flowering and hummingbird overlap in Neotropical Gesneriaceae: Predicting Phenology"
author: "Ben Weinstein"
date: "6/4/2018"
output: 
  html_document:
    toc: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r,message=F,warning=F,include=F}
library(knitr)
opts_chunk$set(message=F,warning=F,echo=F)
library(lubridate)
library(ape)
library(tidyr)
library(kableExtra)
library(boot)
library(dplyr)
library(ggplot2)
library(phytools)
library(stringr)
library(splines)
library(R2jags)
library(truncnorm)

#optionally load
load("/Users/ben/Dropbox/Gesner/Phenology.RData")

#holder for models and chains
models<-list()
chains<-list()
discrepancy<-list()
```
# Transects
```{r}
#transects
transects<-read.csv("data/cleaned/transects.csv",row.names=1)
head(transects) %>% kable() %>% kable_styling()

```

# Phylogeny

```{r}
phy<-read.newick("data/SantaLucia_tree_Newick")
species<-str_match(phy$tip.label,"_(\\w+)")[,2]
tspecies<-unique(transects$Plant)
to_join<-data.frame(Plant=tspecies,phylo=str_match(tspecies," (\\w+)")[,2])
new_names<-data.frame(phylo=species) %>% inner_join(to_join)
phy$tip.label<- as.character(new_names$Plant)
plot(phy)

#variance covariance matrix - attraction
vcov<-vcv(phy,corr = T)

#variance covariance matrix - attraction
ivcov<-solve(vcov)

#Phylogenetic distance matrix
D<-as.matrix(cophenetic(phy))
D<-round(D/max(D),5)

#Identity matrix
I<-diag(nrow(vcov))
```

# Traits
```{r}
traits<-read.csv("data/Species_SantaLucia.csv")

#improve column names
traits<-traits %>% select(Plant=Iplant_Double,min_corolla_tube=Lt,corolla_length=Lc,vertical_diameter=D,stamen_length=S,stamen_exertion=E)

#order the factors
head(transects) %>% kable() %>% kable_styling()
```

### Total Flowers

```{r,fig.height=20,eval=F}
transects %>% group_by(Plant,Year) %>%
ggplot(.,aes(x=julian,y=Flowers,col=as.factor(Year))) + geom_point(size=0.1) + geom_line(aes(group=Year)) + facet_wrap(~Plant,scales="free",ncol=2) + labs(col="Year") + theme_bw()
```

## Peak date

```{r}
transects %>% group_by(Plant,Year) %>% filter(Flowers==max(Flowers)) %>% summarize(julian=mean(julian)) %>% arrange(Plant,Year) %>% ggplot(.,aes(x=Plant,y=julian,col=as.factor(Year))) + geom_point(size=3) + theme_bw() + coord_flip() + labs(x="Plant",y="Julian Day of Peak Flowering",col="Year") 
```

```{r,fig.height=10}
ggplot(data=transects) + geom_density(aes(x=julian,fill=Plant)) + facet_wrap(~Plant,ncol=3) + theme_bw()
```

## Julian Day

```{r,fig.height=15}
#prepare data
indat<-transects

#Easiest to work with jags as numeric ordinal values
indat$Plant<-as.factor(indat$Plant)
indat$jPlant<-as.numeric(indat$Plant)

jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=factor(1:length(levels(indat$Plant))))

#give each row an index
indat$Index<-1:nrow(indat)
```

```{r}
#Source model
source("model/normal_julian.R")

#print model
writeLines(readLines("model/normal_julian.R"))

#Run Model
runModel<-function(Yobs_dat){
  
  
  #Parameters to track
  ParsStage <- c("mu","sigma","fit","fitnew","sq")
  
  #Jags Data

  Dat<-list(
    Yobs=Yobs_dat$julian,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$julian))
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/normal_julian.jags",n.thin=1,n.iter=5000,n.burnin=4500,n.chains=2,DIC=F)
    )
    return(model)
}

models$julian<-runModel(Yobs_dat=indat)
```

```{r} 
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("mu","sigma")]<-lapply(
    splitpc[c("mu","sigma")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
  
  #ragged index
  splitpc[c("sq")]<-lapply(
    splitpc[c("sq")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with indat to get species
    ragged<-sv %>% inner_join(indat[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$julian<-getChains(models$julian) %>% left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$julian %>% filter(parameter %in% c("mu","sigma")) %>%                    ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$julian %>% filter(par %in% c("fit","fitnew")) %>%                    ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=1) + labs(col="chain")
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$julian %>% filter(parameter %in% c("mu","sigma","fit","fitnew")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=1,scales="free")
```

### Estimated phenology

Red is the kernel density from the underlying data
Black is the modeled phenology

```{r,fig.height=11}
predict_plant<-function(mu,sigma){
  value<-dtruncnorm(0:365,a=0,b=365,mean=mu,sd=sigma)
  return(data.frame(mu,sigma,Day=0:365,value))
}

preds<-chains$julian %>% select(-par) %>% filter(!parameter %in% c("fit","fitnew","sq"))  %>% spread(parameter,value) %>% group_by(Draw,chain,Plant) %>% do(predict_plant(.$mu,.$sigma)) %>% group_by(Plant,Day) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(preds)  + geom_ribbon(aes(x=Day,ymin=lower,ymax=upper),alpha=0.5) + geom_line(aes(x=Day,y=mean)) + facet_wrap(~Plant,scales="free",ncol=4) + labs(x="Julian Day",y="Density") + geom_density(data=indat,aes(x=julian),alpha=0.1,fill="red") + theme_bw()
```

# Phylogeny

## Attraction

```{r,fig.height=15}
#prepare data
indat<-transects %>% filter(Plant %in% phy$tip.label)
indat$Plant<-factor(indat$Plant,levels=phy$tip.label)
indat$jPlant<-as.numeric(indat$Plant)
jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=factor(1:length(levels(indat$Plant))))

#give each row an index
indat$Index<-1:nrow(indat)
```

```{r}
#Source model
source("model/normal_attraction.R")

#print model
writeLines(readLines("model/normal_attraction.R"))

#Run Model
runModel<-function(Yobs_dat,D=D){
  
  
  #Parameters to track
  ParsStage <- c("alpha","sigma","fit","fitnew","sq","lambda","e","omega")
  
  #Jags Data

  Dat<-list(
    Yobs=Yobs_dat$julian,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$julian),
    zeros=rep(0,max(c(Yobs_dat$jPlant))),
    D=D)
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/normal_attraction.jags",n.thin=1,n.iter=5000,n.burnin=4500,n.chains=2,DIC=F)
    )
    return(model)
}

models$phylogenetic_attraction<-runModel(Yobs_dat=indat,D=D)
```

#Get Chains
```{r} 
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha","sigma","e")]<-lapply(
    splitpc[c("alpha","sigma","e")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
  
  #ragged index
  splitpc[c("sq")]<-lapply(
    splitpc[c("sq")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with indat to get species
    ragged<-sv %>% inner_join(indat[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$phylogenetic_attraction<-getChains(models$phylogenetic_attraction) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$phylogenetic_attraction %>% filter(parameter %in% c("alpha","sigma","e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$phylogenetic_attraction %>% filter(parameter %in% c("fit","fitnew","lambda","omega")) %>%  ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free")
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$phylogenetic_attraction %>% filter(!parameter %in% c("sq")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

### Estimated phenology

Red is the kernel density from the underlying data
Black is the model

```{r}

predict_plant<-function(alpha,e,sigma){
  mu = alpha + e
  value<-dtruncnorm(0:365,a=0,b=365,mean=mu,sd=sigma)
  return(data.frame(mu,sigma,Day=0:365,value))
}

preds<-chains$phylogenetic_attraction %>% select(-par) %>% filter(parameter %in% c("alpha","sigma","e"))  %>% spread(parameter,value) %>% group_by(Draw,chain,Plant) %>% do(predict_plant(.$alpha,.$e,.$sigma)) %>% group_by(Plant,Day) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(preds)  + geom_ribbon(aes(x=Day,ymin=lower,ymax=upper),alpha=0.5) + geom_line(aes(x=Day,y=mean)) + facet_wrap(~Plant,scales="free") + labs(x="Julian Day",y="Density") + geom_density(data=indat,aes(x=julian),alpha=0.1,fill="red") + theme_bw()
```

## Decay in phylogenetic attraction

```{r}

effect<-function(lambda,D){
  y<-as.numeric(exp(-lambda*D))
  data.frame(lambda,Distance=as.numeric(D),Covariance=y)
}

phy_effect<-chains$phylogenetic_attraction %>% filter(parameter=="lambda") %>% group_by(Draw,chain) %>% do(effect(.$value,D)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(phy_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Phylogenetic Covariance")
```

## Repulsion

```{r}
#Source model
source("model/normal_repulsion.R")

#print model
writeLines(readLines("model/normal_repulsion.R"))

#Run Model
runModel<-function(Yobs_dat,D=D){
  
  
  #Parameters to track
  ParsStage <- c("alpha","sigma","fit","fitnew","sq","lambda","e","omega")
  
  #Jags Data

  Dat<-list(
    Yobs=Yobs_dat$julian,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$julian),
    zeros=rep(0,max(c(Yobs_dat$jPlant))),
    D=D)
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/normal_repulsion.jags",n.thin=1,n.iter=5000,n.burnin=4500,n.chains=2,DIC=F)
    )
    return(model)
}

models$phylogenetic_repulsion<-runModel(Yobs_dat=indat,D=D)
```

#Get Chains
```{r} 
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha","sigma","e")]<-lapply(
    splitpc[c("alpha","sigma","e")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
  
  #ragged index
  splitpc[c("sq")]<-lapply(
    splitpc[c("sq")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with indat to get species
    ragged<-sv %>% inner_join(indat[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$phylogenetic_repulsion<-getChains(models$phylogenetic_repulsion) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$phylogenetic_repulsion %>% filter(parameter %in% c("alpha","sigma","e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$phylogenetic_repulsion %>% filter(par %in% c("fit","fitnew","lambda","omega")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free")
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$phylogenetic_repulsion %>% filter(!parameter %in% c("sq")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

### Estimated phenology

Red is the kernel density from the underlying data
Black is the model

```{r}
preds<-chains$phylogenetic_repulsion %>% select(-par) %>% filter(parameter %in% c("alpha","sigma","e"))  %>% spread(parameter,value) %>% group_by(Draw,chain,Plant) %>% do(predict_plant(.$alpha,.$e,.$sigma)) %>% group_by(Plant,Day) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(preds)  + geom_ribbon(aes(x=Day,ymin=lower,ymax=upper),alpha=0.5) + geom_line(aes(x=Day,y=mean)) + facet_wrap(~Plant,scales="free") + labs(x="Julian Day",y="Density") + geom_density(data=indat,aes(x=julian),alpha=0.1,fill="red") + theme_bw()
```

## Decay in phylogenetic repulsion

```{r}

effect_repulsion<-function(lambda,D){
  y<-as.numeric(solve(exp(-lambda*D)))
  data.frame(lambda,Distance=as.numeric(D),Covariance=y)
}

phyrepulse_effect<-chains$phylogenetic_repulsion %>% filter(parameter=="lambda") %>% group_by(Draw,chain) %>% do(effect_repulsion(.$value,D)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(phyrepulse_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

# Traits

## Trait Attraction

```{r}

#Distance matrix
rownames(traits)<-traits[,1]
Dtraits<-as.matrix(dist(traits[,-1]))
Dtraits<-Dtraits/max(Dtraits)

#filter data to match traits
indat<-transects%>% filter(Plant %in% rownames(traits))
indat$Plant<-factor(indat$Plant,levels=rownames(traits))
indat$jPlant<-as.numeric(indat$Plant)
jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=factor(1:length(levels(indat$Plant))))

#give each row an index
indat$Index<-1:nrow(indat)
```

```{r}
#Source model
source("model/normal_attraction.R")

#print model
writeLines(readLines("model/normal_attraction.R"))

#Run Model
runModel<-function(Yobs_dat,D){
  
  
  #Parameters to track
  ParsStage <- c("alpha","sigma","fit","fitnew","sq","lambda","e")
  
  #Jags Data

  Dat<-list(
    Yobs=Yobs_dat$julian,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$julian),
    zeros=rep(0,max(c(Yobs_dat$jPlant))),
    D=D)
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/normal_attraction.jags",n.thin=1,n.iter=5000,n.burnin=4500,n.chains=2,DIC=F)
    )
    return(model)
}

models$trait_attraction<-runModel(Yobs_dat=indat,D=Dtraits)
```

#Get Chains
```{r} 
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha","sigma","e")]<-lapply(
    splitpc[c("alpha","sigma","e")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
  
  #ragged index
  splitpc[c("sq")]<-lapply(
    splitpc[c("sq")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with indat to get species
    ragged<-sv %>% inner_join(indat[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$trait_attraction<-getChains(models$trait_attraction) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$trait_attraction %>% filter(parameter %in% c("alpha","sigma","e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$trait_attraction %>% filter(par %in% c("fit","fitnew","lambda")) %>%  ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free")
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$trait_attraction %>% filter(!parameter %in% c("sq")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

### Estimated phenology

Red is the kernel density from the underlying data
Black is the model

```{r}
preds<-chains$trait_attraction %>% select(-par) %>% filter(parameter %in% c("alpha","sigma","e"))  %>% spread(parameter,value) %>% group_by(Draw,chain,Plant) %>% do(predict_plant(.$alpha,.$e,.$sigma)) %>% group_by(Plant,Day) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(preds)  + geom_ribbon(aes(x=Day,ymin=lower,ymax=upper),alpha=0.5) + geom_line(aes(x=Day,y=mean)) + facet_wrap(~Plant,scales="free") + labs(x="Julian Day",y="Density") + geom_density(data=indat,aes(x=julian),alpha=0.1,fill="red") + theme_bw()
```

## Decay in trait attraction

```{r}
trait_effect<-chains$trait_attraction %>% filter(parameter=="lambda") %>% group_by(Draw,chain) %>% do(effect(.$value,Dtraits)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(trait_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

## Repulsion

```{r}
#Source model
source("model/normal_repulsion.R")

#print model
writeLines(readLines("model/normal_repulsion.R"))

#Run Model
runModel<-function(Yobs_dat,D){
  
  
  #Parameters to track
  ParsStage <- c("alpha","sigma","fit","fitnew","sq","lambda","e","omega")
  
  #Jags Data

  Dat<-list(
    Yobs=Yobs_dat$julian,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$julian),
    zeros=rep(0,max(c(Yobs_dat$jPlant))),
    D=D)
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/normal_repulsion.jags",n.thin=1,n.iter=5000,n.burnin=4500,n.chains=2,DIC=F)
    )
    return(model)
}

models$trait_repulsion<-runModel(Yobs_dat=indat,D=Dtraits)
```

#Get Chains
```{r} 
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha","sigma","e")]<-lapply(
    splitpc[c("alpha","sigma","e")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
  
  #ragged index
  splitpc[c("sq")]<-lapply(
    splitpc[c("sq")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with indat to get species
    ragged<-sv %>% inner_join(indat[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$trait_repulsion<-getChains(models$trait_repulsion) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$trait_repulsion %>% filter(parameter %in% c("alpha","sigma","e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$trait_repulsion %>% filter(par %in% c("fit","fitnew","lambda","omega")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free")
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$trait_repulsion %>% filter(!parameter %in% c("sq")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

### Estimated phenology

Red is the kernel density from the underlying data
Black is the model

```{r}
preds<-chains$trait_repulsion %>% select(-par) %>% filter(parameter %in% c("alpha","sigma","e"))  %>% spread(parameter,value) %>% group_by(Draw,chain,Plant) %>% do(predict_plant(.$alpha,.$e,.$sigma)) %>% group_by(Plant,Day) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(preds)  + geom_ribbon(aes(x=Day,ymin=lower,ymax=upper),alpha=0.5) + geom_line(aes(x=Day,y=mean)) + facet_wrap(~Plant,scales="free") + labs(x="Julian Day",y="Density") + geom_density(data=indat,aes(x=julian),alpha=0.1,fill="red") + theme_bw()
```

## Decay in trait repulsion

```{r}
traitrepulse_effect<-chains$trait_repulsion %>% filter(parameter=="lambda") %>% group_by(Draw,chain) %>% do(effect_repulsion(.$value,Dtraits)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(traitrepulse_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

# Model Comparison


```{r}
#reduce models to a single df
for(x in 1:length(chains)){
  chains[[x]]$Model<-names(chains)[[x]]
}

allchains<-bind_rows(chains)

#create an attraction/repulsion label
allchains$Effect<-str_detect(allchains$Model,"repulsion")

allchains[allchains$Effect==TRUE,"Effect"]<-"Repulsion"
allchains[!allchains$Effect==TRUE,"Effect"]<-"Attraction"

```

## Alpha

```{r,fig.height=12,fig.width=10}
allpars<-allchains %>% filter(!parameter %in% c("sq")) %>% group_by(Model,Plant,parameter) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

#Alphas
allpars %>% filter(parameter %in% "alpha") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + facet_wrap(~Plant,scales="free",ncol=3) + coord_flip()
```

## E: The effect of autocorrelation on mean flowering date

```{r,fig.height=12,fig.width=10}
allpars %>% filter(parameter %in% "e") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + facet_wrap(~Plant,scales="free",ncol=3) + coord_flip() + labs(y="E")
```

## Mu

Reconstructed from alpha + E, do the parameters just tradeoff?

```{r,fig.height=12,fig.width=10}


#get julian estimate
jest<-allchains %>% select(-par) %>% filter(Model %in% "julian",parameter %in% c("mu"))%>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) 

allchains %>% select(-par) %>% filter(!Model %in% "julian",parameter %in% c("alpha","e")) %>% spread(parameter,value) %>% mutate(mu=alpha+e) %>% group_by(Model,Plant) %>% summarize(mean=mean(mu),lower=quantile(mu,0.05),upper=quantile(mu,0.95)) %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + facet_wrap(~Plant,scales="free",ncol=3) + coord_flip() + labs(y="mu") + geom_pointrange(data=jest,aes(ymin=lower,ymax=upper),col="red")


```

### Estimated phenology

Red is the kernel density from the underlying data
Black is the model

```{r,fig.height=12,fig.width=12}
#need to compute seperately for julian and the other models
correlated_predictions<-allchains %>% select(-par) %>% filter(!Model %in% "julian") %>% filter(parameter %in% c("alpha","sigma","e"))  %>% spread(parameter,value) %>% group_by(Model,Draw,chain,Plant) %>% do(predict_plant(.$alpha,.$e,.$sigma)) %>% group_by(Model,Plant,Day) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(correlated_predictions)  + geom_ribbon(aes(x=Day,ymin=lower,ymax=upper,fill=Model),alpha=0.2) + geom_line(aes(x=Day,y=mean)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Julian Day",y="Density") + geom_density(data=indat,aes(x=julian),alpha=0.1,fill="red") + theme_bw()
```

## Effect of autocorrelation

```{r}

autocorrelation<-allchains %>% select(-par) %>% filter(parameter %in% "e")  %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(autocorrelation) + geom_pointrange(aes(x=Plant,ymin=lower,ymax=upper,y=mean,col=Model))+ coord_flip() + labs(y="Effect of julian day")
```

## Decay in autocorrelation effect

```{r}

phy_effect$Model<-"Phylogenetic Attraction"
phyrepulse_effect$Model<-"Phylogenetic Repulsion"
trait_effect$Model<-"Trait Attraction"
traitrepulse_effect$Model<-"Trait Repulsion"

est_effect<-bind_rows(list(phy_effect,phyrepulse_effect,trait_effect,traitrepulse_effect))
ggplot(est_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance") + facet_wrap(~Model,scales="free")
```

# Model Fit

## Bayesian pvalue

```{r,fig.height=10,fig.width=10}

fitstat<-allchains %>% filter(par %in% c("fit","fitnew")) %>% select(-par) %>% mutate(value=value) %>% spread(parameter,value) 

ymin<-min(fitstat$fit)
ymax<-max(fitstat$fit)
ab<-data.frame(x=seq(0,ymax,1),y=seq(0,ymax,1))

ggplot(data=fitstat,aes(x=fit,y=fitnew)) + geom_point(aes(col=Model)) + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data",col="Model")  + ggtitle("Posterior predictive check") + coord_fixed() + geom_line(data=ab,aes(x=x,y=y),group=1,linetype="dashed") 

#Bayesian p-value
fitstat %>% group_by(Model) %>% summarize(p=sum((fitnew>fit)/n()))
```

## Overall

```{r}
allchains %>% filter(parameter %in% "fit") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()
```

## By Species

```{r}

allchains %>% filter(parameter %in% "sq") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sqrt(sum(value)/n())) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(x=Plant,y=mean,col=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Root Mean Squared Error") + theme_bw()
```

#Prediction

Todo

```{r}
save.image("/Users/ben/Dropbox/Gesner/Phenology.RData")
```
