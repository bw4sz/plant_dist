---
title: "Co-flowering and hummingbird overlap in Neotropical Gesneriaceae: Predicting Phenology"
author: "Ben Weinstein"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

Ideas:

```{r,message=F,warning=F,include=F}
library(knitr)
opts_chunk$set(message=F,warning=F,echo=F)
library(lubridate)
library(ape)
library(kableExtra)
library(boot)
library(ggplot2)
library(phytools)
library(stringr)
library(ggbiplot)
library(splines)
library(R2jags)
library(truncnorm)
library(tidyr)
library(dplyr)

#optionally load
#load("/Users/ben/Dropbox/Gesner/Phenology.RData")

#holder for models and chains
models<-list()
chains<-list()
discrepancy<-list()

#source functions
source("functions.R")
```

# Transects
```{r}
#transects
transects<-read.csv("data/cleaned/transects.csv",row.names=1)
head(transects) %>% kable() %>% kable_styling()

#drop NA elevations
transects<-transects %>% filter(!is.na(ele))
```

# Interactions

```{r}
intdata<-as.matrix(read.csv("PInteraction.csv",row.names = 1))

Dint<-as.matrix(dist(t(intdata),method = "euclidean"))

rownames(Dint)<-str_replace(rownames(Dint),"\\."," ")
colnames(Dint)<-str_replace(colnames(Dint),"\\."," ")

ggbiplot(prcomp(intdata),scale = 1) 

Dint<-Dint/max(Dint)

ggplot(reshape2::melt(Dint),aes(x=Var1,y=Var2,fill=value)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + theme(axis.text.x = element_text(angle = -90)) + labs(fill="Pollinator Overlap") 

```

# Phylogeny

```{r}
phy<-read.newick("data/SantaLucia_tree_Newick")
species<-str_match(phy$tip.label,"_(\\w+)")[,2]
tspecies<-unique(transects$Plant)
to_join<-data.frame(Plant=tspecies,phylo=str_match(tspecies," (\\w+)")[,2])
new_names<-data.frame(phylo=species) %>% inner_join(to_join)
phy$tip.label<- as.character(new_names$Plant)
plot(phy)

#variance covariance matrix - attraction
vcov<-vcv(phy,corr = T)

#variance covariance matrix - attraction
ivcov<-solve(vcov)

#Phylogenetic distance matrix
D<-as.matrix(cophenetic(phy))
D<-round(D/max(D),5)

#Identity matrix
I<-diag(nrow(vcov))

#match transects with phylogeny
transects<-transects %>% filter(Plant %in% phy$tip.label) %>% droplevels()
```

# Traits
```{r}
traits<-read.csv("data/Species_SantaLucia.csv")

#improve column names
traits<-traits %>% select(Plant=Iplant_Double,min_corolla_tube=Lt,corolla_length=Lc,vertical_diameter=D,stamen_length=S,stamen_exertion=E)

#match with phylogeny
traits<-traits %>% filter(Plant %in% phy$tip.label)
```

```{r}
#Distance matrix
rownames(traits)<-traits[,1]
Dtraits<-as.matrix(dist(traits[,-1]))
Dtraits<-Dtraits/max(Dtraits)
```

### Total Flowers

```{r,fig.height=20,eval=F}
transects %>% group_by(Plant,Year) %>%
ggplot(.,aes(x=julian,y=Flowers,col=as.factor(Year))) + geom_point(size=0.1) + geom_line(aes(group=Year)) + facet_wrap(~Plant,scales="free",ncol=2) + labs(col="Year") + theme_bw()
```

## Peak date

```{r}
transects %>% group_by(Plant,Year) %>% filter(Flowers==max(Flowers)) %>% dplyr::summarize(julian=mean(julian)) %>% arrange(Plant,Year) %>% ggplot(.,aes(x=Plant,y=julian,col=as.factor(Year))) + geom_point(size=3) + theme_bw() + coord_flip() + labs(x="Plant",y="Julian Day of Peak Flowering",col="Year") 
```

```{r,fig.height=10}
ggplot(data=transects) + geom_density(aes(x=julian,fill=Plant)) + facet_wrap(~Plant,ncol=3) + theme_bw()
```

As range

```{r,fig.height=10}

transects %>% group_by(Plant,Year) %>% summarize(mean=mean(julian),lower=quantile(julian,0.05),upper=quantile(julian,0.95)) %>% ggplot(.,aes(x=Plant,col=as.factor(Year))) + geom_pointrange(aes(y=mean,min=lower,max=upper),size=0.3,position = position_jitter(height = 0.1)) + coord_flip() + labs(y="Julian Day",col="Year") + theme_bw()
```

```{r}
transects %>% group_by(Plant,julian) %>% summarise(n=sum(Flowers)) %>% filter(!is.na(n)) %>%
ggplot(.,aes(x=julian,y=n)) + geom_point(size=2) + labs(col="Year") + theme_bw() + facet_wrap(~Plant,scales = "free_y")
```


```{r,fig.height=15}
## Infer absences
transects$Year<-as.character(format(as.POSIXlt(transects$Date),"%Y"))
transects$Month<-as.numeric(format(as.POSIXlt(transects$Date),"%m"))
transects$Site<-as.numeric(as.factor(cut(transects$ele,seq(1300,2500,200))))
```

```{r}
#limit to peak flowering, more than 5% of plants for the year are in bloom.
sumf<-transects %>% group_by(Plant,Site,Month,Year) %>% dplyr::summarize(n=n(),ele=mean(ele)) %>% mutate(Year=as.factor(Year))%>% group_by(Plant,Year) %>% filter(n >sum(n)*0.05) %>% mutate(n=(n>0)*1)

#Which combinations are sampled.
sampled<-sumf %>% ungroup() %>% distinct(Site,Month,Year) %>% arrange(Site,Month,Year) %>% group_by(Site,Month,Year) %>% do(all_plants(.))

#merge elevation for 0 count, get's mean elevation of that day
mean_ele<-transects %>% group_by(Site,Month,Year) %>% summarize(ele=mean(ele))
zero_count<-sampled %>% anti_join(sumf,by=c("Plant","Site","Month","Year")) %>% inner_join(mean_ele)

transects_zero<-bind_rows(sumf,zero_count)
```

## Species elevation ranges

```{r}
ggplot(transects_zero %>% filter(!n==0),aes(x=Plant,y=ele)) + geom_boxplot() + coord_flip() + labs(y="Elevation (m)") + theme_bw()
ggsave("Figures/ElevationRanges.png",height=5,width=7,dpi=300)
```

## Flowering Data Matrix

```{r}
transects_zero<-transects_zero %>% ungroup() %>% mutate(Index=group_indices(.,Site,Month,Year))

transects_zero %>% mutate(Month=paste(Month,Year)) %>% ggplot(.) + geom_tile(aes(x=Index,y=Plant,fill=as.factor(n>0))) + labs(fill="Flowering",x="Observation")  + theme_bw() + scale_fill_manual(values=c("grey80","black"))
```

```{r,fig.height=20,fig.width=15}
ggplot(transects_zero) + geom_tile(aes(x=as.factor(Month),y=Plant,fill=as.factor(n>0))) + labs(fill="Flowering")  + theme_bw() + facet_wrap(Year~Site) + scale_fill_manual(values=c("grey80","black")) + labs(x="Month")
ggsave("Figures/DataMatrix_Index.png",height=4,width=8)
```

```{r,fig.width=10}
#prepare data
indat<-transects_zero 

#Easiest to work with jags as numeric ordinal values
indat$Plant<-as.factor(indat$Plant)
indat$jPlant<-as.numeric(indat$Plant)

jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=1:length(levels(indat$Plant)))

indat %>% group_by(Plant,Month) %>% summarize(p=sum(n)/n()) %>% ggplot(aes(y=p,x=as.factor(Month))) + geom_point() + geom_line(aes(group=1)) + facet_wrap(~Plant) + labs(x="Proportion of data in flower")

indat %>% group_by(Plant,Month,Year) %>% summarize(p=sum(n)/n()) %>% ggplot(aes(y=p,col=Year,x=as.factor(Month))) + geom_point() + geom_line(aes(group=1)) + facet_wrap(~Plant) + labs(x="Proportion of data in flower")

#hold 2017 data aside for prediction
to_predict<-indat %>% filter(Year %in% "2017")
indat<-indat %>% filter(!Year %in% "2017")

#Index for jags
indat$Index<-as.factor(1:nrow(indat))
to_predict$Index<-as.factor(1:nrow(to_predict))
```

# Baseline model

Equal probability of flowering at anytime.

```{r}
#Source model
source("model/threshold_baseline.R")

#print model
writeLines(readLines("model/threshold_baseline.R"))

#Run Model
runModel<-function(Yobs_dat,Ynew_dat){
  
  #Parameters to track
  ParsStage <- c("alpha","fit","fitnew","discrepancy","pred_error","fitpred","Ynew","p")
   
  #Jags Data

    Dat<-list(
    Nobs=length(Yobs_dat$n),
    Y=Yobs_dat$n,
    Plants=max(Yobs_dat$jPlant),
    Plant=Yobs_dat$jPlant,

    #Prediction data
    Npreds=length(Ynew_dat$n),
    Ypred=Ynew_dat$n,
    PredPlant=Ynew_dat$jPlant)
    
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/threshold_baseline.jags",n.thin=2,n.iter=1000,n.burnin=500,n.chains=2,DIC=F)
    )
    return(model)
}

models$baseline<-runModel(Yobs_dat=indat,Ynew_dat=to_predict)
```

#Get Chains
```{r} 
getChains<-function(mod,indat,to_predict){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha")]<-lapply(
    splitpc[c("alpha")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=as.numeric(as.character(sv)))  %>% left_join(jagsIndexPlants)
    })
  
    #double index - observed
  splitpc[c("Ynew","discrepancy","p")]<-lapply(
    splitpc[c("Ynew","discrepancy","p")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,Index=sv)
    pc<-pc %>% inner_join(indat)
    })
  
  #Prediction
    splitpc[c("pred_error")]<-lapply(
    splitpc[c("pred_error")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,Index=sv)
    pc<-pc %>% inner_join(to_predict)
    })
  
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$baseline<-getChains(models$baseline,indat,to_predict)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$baseline %>% filter(parameter %in% c("alpha")) %>%                    ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~Plant,scales="free")
```

```{r}
chains$baseline %>% filter(parameter %in% c("fit","fitnew","fitpred")) %>%                    ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=1) + labs(col="chain")
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$baseline %>% filter(parameter %in% c("alpha","fit","fitnew","fitpred")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=1,scales="free")
```

# Phylogeny

## Attraction

```{r}
#Run Model
runModel_autocorrelation<-function(Yobs_dat,Ynew_dat,D=D,mod_name){
  
#Source model
source(paste("model/",mod_name,".R",sep=""))

#print model
writeLines(readLines(paste("model/",mod_name,".R",sep="")))

  #Parameters to track
  ParsStage <- c("p","alpha","fit","fitnew","discrepancy","pred_error","lambda_cov","e","omega","fitpred","Ynew","gamma")
   
  #Jags Data
    Dat<-list(
    Nobs=length(Yobs_dat$n),
    Y=Yobs_dat$n,
    Plants=max(Yobs_dat$jPlant),
    Plant=Yobs_dat$jPlant,
    Months=max(Yobs_dat$Month),
    Month=Yobs_dat$Month,
    Sites=max(Yobs_dat$Site),
    Site=Yobs_dat$Site,
    
    #Autocorrelation data
    zeros=rep(0,max(Yobs_dat$jPlant)),
    D=D,
    I=I,
    
    #Prediction data
    Npreds=length(Ynew_dat$n),
    Ypred=Ynew_dat$n,
    NewPlant=Ynew_dat$jPlant,
    NewSite=Ynew_dat$Site,
    NewMonth=Ynew_dat$Month)
    
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file=paste("model/",mod_name,".jags",sep=""),n.thin=2,n.iter=1000,n.burnin=500,n.chains=2,DIC=F)
    )
    return(model)
}

models$phylogenetic_attraction<-runModel_autocorrelation(Yobs_dat=indat,Ynew_dat=to_predict,D=D,mod_name = "threshold_attraction")
```

#Get Chains
```{r} 
getChains<-function(mod,indat,to_predict){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
      #double index - observed
  splitpc[c("Ynew","discrepancy","p")]<-lapply(
    splitpc[c("Ynew","discrepancy","p")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,Index=sv)
    pc<-pc %>% inner_join(indat)
    })
  
    #single index
  splitpc[c("alpha")]<-lapply(
    splitpc[c("alpha")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=as.numeric(as.character(sv)))  %>% left_join(jagsIndexPlants)
    })
  
  #Prediction
    splitpc[c("pred_error")]<-lapply(
    splitpc[c("pred_error")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,Index=sv)
    pc<-pc %>% inner_join(to_predict)
    })
    
    #triple index
  splitpc[c("e")]<-lapply(
    splitpc[c("e")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)]"))[,3:4]
    colnames(sv)<-c("jPlant","Site")
    sv$jPlant<-as.numeric(as.character(sv$jPlant))
    sv$Site<-as.numeric(as.character(sv$Site))
    sv<-sv %>% inner_join(jagsIndexPlants)

    pc<-data.frame(x,sv)
    })
  
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$phylogenetic_attraction<-getChains(models$phylogenetic_attraction,indat,to_predict)
```

### Evaluate convergence

```{r,fig.height=15,fig.width=15}
chains$phylogenetic_attraction %>% filter(parameter %in% c("alpha")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~Plant,scales="free")

chains$phylogenetic_attraction %>% filter(parameter %in% c("e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(Month~Plant,scales="free")
```

```{r}
chains$phylogenetic_attraction %>% filter(parameter %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>%  ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$phylogenetic_attraction %>% filter(!parameter %in% c("discrepancy","Ynew","pred_error")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Effect of phylogenetic attraction

```{r}
result<-chains$phylogenetic_attraction %>% filter(parameter %in% c("omega","gamma","lambda_cov")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain)  %>% do(tauC_attraction(omega=.$omega,gamma=.$gamma,I=I,D=D,lambda_cov=.$lambda_cov)) %>% group_by(Var1,Var2) %>% filter(!is.na(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(result,aes(x=Var1,y=Var2,fill=mean)) + geom_tile() + scale_fill_gradient2(low="red",mid="white",high="blue") + labs(x="",y="",fill="Mean Covariance") + theme(axis.text.x = element_text(angle=-90))
```

```{r}
phy_effect<-chains$phylogenetic_attraction %>% filter(parameter %in% c("lambda_cov","omega","gamma")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>% do(effect(lambda=.$lambda_cov,D=D,omega=.$omega,gamma=.$gamma)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(phy_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

## Repulsion

```{r}
models$phylogenetic_repulsion<-runModel_autocorrelation(Yobs_dat=indat,Ynew_dat=to_predict,D=D,mod_name = "threshold_repulsion")
```

#Get Chains

```{r}
chains$phylogenetic_repulsion<-getChains(models$phylogenetic_repulsion,indat,to_predict) 
```

### Evaluate convergence

```{r,fig.height=10,fig.width=12}
chains$phylogenetic_repulsion %>% filter(parameter %in% c("e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(Month~Plant,scales="free")
```

```{r}
chains$phylogenetic_repulsion %>% filter(par %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$phylogenetic_repulsion %>% filter(!parameter %in% c("discrepancy","Ynew","prediction","pred_error")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Effect of phylogenetic repulsion

```{r}
result<-chains$phylogenetic_repulsion %>% filter(parameter %in% c("omega","gamma","lambda_cov")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>%  do(tauC_repulsion(omega=.$omega,gamma=.$gamma,I=I,D=D,lambda_cov=.$lambda_cov)) %>% group_by(Var1,Var2) %>% filter(!is.na(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(result,aes(x=Var1,y=Var2,fill=mean)) + geom_tile() + scale_fill_gradient2(low="red",mid="white",high="blue") + labs(x="",y="",fill="Mean Covariance") + theme(axis.text.x = element_text(angle=-90))
```

```{r}
phyrepulse_effect<-chains$phylogenetic_repulsion %>% filter(parameter %in% c("lambda_cov","omega","gamma")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>% do(effect_repulsion(lambda=.$lambda_cov,D=D,omega=.$omega,gamma=.$gamma)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(phyrepulse_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

# Traits

## Trait Attraction

```{r}
models$trait_attraction<-runModel_autocorrelation(Yobs_dat=indat,Ynew_dat=to_predict,D=Dtraits,mod_name = "threshold_attraction")
```

#Get Chains

```{r}
chains$trait_attraction<-getChains(models$trait_attraction,indat,to_predict) 
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$trait_attraction %>% filter(parameter %in% c("e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(Month~Plant,scales="free")
```

```{r}
chains$trait_attraction %>% filter(par %in% c("fit","fitnew","lambda_cov","fitpred","omega","gamma")) %>%  ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$trait_attraction %>% filter(!parameter %in% c("discrepancy","Ynew","prediction","pred_error")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Effect of trait attraction

```{r}
result<-chains$trait_attraction %>% filter(parameter %in% c("omega","gamma","lambda_cov")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>%  do(tauC_attraction(omega=.$omega,gamma=.$gamma,I=I,D=Dtraits,lambda_cov=.$lambda_cov)) %>% group_by(Var1,Var2) %>%filter(!is.na(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(result,aes(x=Var1,y=Var2,fill=mean)) + geom_tile() + scale_fill_gradient2(low="red",mid="white",high="blue") + labs(x="",y="",fill="Mean Covariance") + theme(axis.text.x = element_text(angle=-90))
```

```{r}
trait_effect<-chains$trait_attraction %>%  filter(parameter %in% c("lambda_cov","omega","gamma")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>% do(effect(lambda=.$lambda_cov,D=Dtraits,omega=.$omega,gamma=.$gamma)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))
ggplot(trait_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

## Repulsion

```{r}
models$trait_repulsion<-runModel_autocorrelation(Yobs_dat=indat,Ynew_dat=to_predict,D=Dtraits,mod_name = "threshold_repulsion")
```

#Get Chains

```{r}
chains$trait_repulsion<-getChains(models$trait_repulsion,indat,to_predict) 
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$trait_repulsion %>% filter(parameter %in% c("e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(Month~Plant,scales="free")
```

```{r}
chains$trait_repulsion %>% filter(par %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$trait_repulsion %>% filter(!parameter %in% c("discrepancy","Ynew","prediction","pred_error")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Effect of trait repulsion

```{r}
result<-chains$trait_repulsion %>% filter(parameter %in% c("omega","gamma","lambda_cov")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>%  do(tauC_repulsion(omega=.$omega,gamma=.$gamma,I=I,D=Dtraits,lambda_cov=.$lambda_cov)) %>% group_by(Var1,Var2) %>% filter(!is.na(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(result,aes(x=Var1,y=Var2,fill=mean)) + geom_tile() + scale_fill_gradient2(low="red",mid="white",high="blue") + labs(x="",y="",fill="Mean Covariance") + theme(axis.text.x = element_text(angle=-90))
```
```{r}
traitrepulse_effect<-chains$trait_repulsion %>% filter(parameter %in% c("lambda_cov","omega","gamma")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>% do(effect_repulsion(lambda=.$lambda_cov,D=Dtraits,omega=.$omega,gamma=.$gamma)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(traitrepulse_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

# Interaction

## Attraction

```{r}
models$interaction_attraction<-runModel_autocorrelation(Yobs_dat=indat,Ynew_dat=to_predict,D=Dint,mod_name = "threshold_attraction")
```

```{r}
chains$interaction_attraction<-getChains(models$interaction_attraction,indat,to_predict)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$interaction_attraction %>% filter(parameter %in% c("e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(Month~jPlant,scales="free")
```

```{r}
chains$interaction_attraction %>% filter(parameter %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>%  ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$interaction_attraction %>% filter(!parameter %in% c("discrepancy","Ynew","prediction","pred_error")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Effect of interaction attraction

```{r}
result<-chains$interaction_attraction %>% filter(parameter %in% c("omega","gamma","lambda_cov")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>%  do(tauC_attraction(omega=.$omega,gamma=.$gamma,I=I,D=Dint,lambda_cov=.$lambda_cov)) %>% group_by(Var1,Var2) %>% filter(!is.na(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(result,aes(x=Var1,y=Var2,fill=mean)) + geom_tile() + scale_fill_gradient2(low="red",mid="white",high="blue") + labs(x="",y="",fill="Mean Covariance") + theme(axis.text.x = element_text(angle=-90))
```

```{r}

int_effect<-chains$interaction_attraction %>% filter(parameter %in% c("lambda_cov","omega","gamma")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>% do(effect(lambda=.$lambda_cov,D=Dint,omega=.$omega,gamma=.$gamma)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(int_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

## Repulsion

```{r}
models$interaction_repulsion<-runModel_autocorrelation(Yobs_dat=indat,Ynew_dat=to_predict,D=Dint,mod_name = "threshold_repulsion")
```

#Get Chains

```{r}
chains$interaction_repulsion<-getChains(models$interaction_repulsion,indat,to_predict) 
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$interaction_repulsion %>% filter(parameter %in% c("e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(Month~Plant,scales="free")
```

```{r}
chains$interaction_repulsion %>% filter(par %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$interaction_repulsion %>% filter(!parameter %in% c("discrepancy","Ynew","prediction","pred_error")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Effect of interaction repulsion

```{r}
result<-chains$interaction_repulsion %>% filter(parameter %in% c("omega","gamma","lambda_cov")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>%  do(tauC_repulsion(omega=.$omega,gamma=.$gamma,I=I,D=Dint,lambda_cov=.$lambda_cov)) %>% group_by(Var1,Var2) %>% filter(!is.na(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(result,aes(x=Var1,y=Var2,fill=mean)) + geom_tile() + scale_fill_gradient2(low="red",mid="white",high="blue") + labs(x="",y="",fill="Mean Covariance") + theme(axis.text.x = element_text(angle=-90))
```

```{r}
intrepulse_effect<-chains$interaction_repulsion %>% filter(parameter %in% c("lambda_cov","omega","gamma")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Draw,chain) %>% do(effect_repulsion(lambda=.$lambda_cov,D=Dint,omega=.$omega,gamma=.$gamma)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(intrepulse_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

# Model Comparison

```{r}
#reduce models to a single df
for(x in 1:length(chains)){
  chains[[x]]$Model<-names(chains)[[x]]
}

allchains<-bind_rows(chains)

#create an attraction/repulsion label
allchains$Effect<-str_detect(allchains$Model,"repulsion")

allchains[!allchains$Effect==TRUE,"Effect"]<-"Attraction"
allchains[allchains$Effect==TRUE,"Effect"]<-"Repulsion"
allchains[allchains$Model=="julian","Effect"]<-NA
```

### E: The effect of autocorrelation

```{r,fig.height=40,fig.width=12}
allchains %>% filter(parameter %in% "e") %>% group_by(Model,jPlant,Site) %>% mutate(value=value) %>%  summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(y=mean,x=Model,col=as.factor(Site))) + geom_pointrange(aes(ymin=lower,ymax=upper)) + facet_wrap(Site~Plant,ncol=6,scales="free_x") + labs(y="Effect of Association on Flowering",x="",col="Site") + coord_flip() + geom_hline(yintercept=0,linetype="dashed")
```

# P(Flowering)

```{r,fig.height=40,fig.width=12}
allchains %>% filter(parameter %in% "p") %>% group_by(Model,jPlant,Site) %>% mutate(value=value) %>%  summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(y=mean,x=Model,col=as.factor(Site))) + geom_pointrange(aes(ymin=lower,ymax=upper)) + facet_wrap(Site~Plant,ncol=6) + labs(y="Effect of Association on Flowering",x="",col="Site") + coord_flip() 
```
# One example

Glossoloma purpureum

```{r}
indat %>% filter(Plant=="Glossoloma purpureum") %>% group_by(Plant,Site) %>% summarize(p=sum(n)/n()) %>% ggplot(.,aes(x=as.factor(Site),y=p)) + geom_point() + labs(x="Site",y="Proportion of data in bloom") 

to_predict %>% filter(Plant=="Glossoloma purpureum") %>% group_by(Plant,Site) %>% summarize(p=sum(n)/n()) %>% ggplot(.,aes(x=as.factor(Site),y=p)) + geom_point() + labs(x="Site",y="Proportion of data in bloom")  + ggtitle("Prediction")

allchains %>% filter(parameter %in% "Ynew",Plant=="Glossoloma purpureum") %>% group_by(Model,Plant,Site) %>% summarize(p=sum(value)/n()) %>% ggplot(.,aes(x=as.factor(Site),y=p,col=Model)) + geom_point() + labs(x="Site",y="Proportion of data in bloom") 

allchains %>% filter(parameter %in% "p",Plant=="Glossoloma purpureum") %>% group_by(Model,Plant,Site) %>% summarize(mean=mean(value)) %>% ggplot(.,aes(x=as.factor(Site),y=mean,col=Model)) + geom_point() + labs(x="Site",y="p") 

allchains %>% filter(parameter %in% "alpha",Plant=="Glossoloma purpureum") %>% group_by(Model,Plant,Site) %>% mutate(value=inv.logit(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + labs(x="Model",y="inv.logit(alpha)") + ggtitle("Species Intercept") +  coord_flip()


allchains %>% filter(parameter %in% "e",Plant=="Glossoloma purpureum") %>% group_by(Model,Plant,Site) %>% mutate(value=inv.logit(value)) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(x=as.factor(Site),y=mean,col=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + labs(x="Site",y="inv.logit(e)") + ggtitle("Effect of association on flowering") 

allchains %>% filter(parameter %in% "discrepancy",Plant=="Glossoloma purpureum") %>% group_by(Model,Plant,Site) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(x=as.factor(Site),y=mean,col=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + labs(x="Site",y="Obs - p(Flowering)") + ggtitle("Discrepancy")


```

# By site

## 1300m - 1500m

```{r}
allchains %>% filter(parameter %in% "Ynew") %>% group_by(Model,jPlant,Site,Month) %>% summarize(p=sum(value)/n()) %>% filter(Site==1) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=p)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="p(Flowering)") 
```

```{r}
 allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Model,jPlant,Site,Month) %>% summarize(mean=mean(value)) %>% filter(Site==1) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=mean)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="Discrepancy") 

```

## 1500-1700m

```{r}
allchains %>% filter(parameter %in% "Ynew") %>% group_by(Model,jPlant,Site,Month) %>% summarize(p=sum(value)/n()) %>% filter(Site==2) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=p)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="p(Occ)") 
```

```{r}
 allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Model,jPlant,Site,Month) %>% summarize(mean=mean(value)) %>% filter(Site==2) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=mean)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="Discrepancy") 

```

## 1700-1900 

```{r}
allchains %>% filter(parameter %in% "Ynew") %>% group_by(Model,jPlant,Site,Month) %>% summarize(p=sum(value)/n()) %>% filter(Site==3) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=p)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="p(Occ)") 
```

```{r}
 allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Model,jPlant,Site,Month) %>% summarize(mean=mean(value)) %>% filter(Site==3) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=mean)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="Discrepancy") 
```

## 1900-2100m

```{r}
allchains %>% filter(parameter %in% "Ynew") %>% group_by(Model,jPlant,Site,Month) %>% summarize(p=sum(value)/n()) %>% filter(Site==4) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=p)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="p(Occ)") 
```

```{r}
 allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Model,jPlant,Site,Month) %>% summarize(mean=mean(value)) %>% filter(Site==4) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=mean)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="Discrepancy") 

```

## 2100-2300m

```{r}
allchains %>% filter(parameter %in% "Ynew") %>% group_by(Model,jPlant,Site,Month) %>% summarize(p=sum(value)/n()) %>% filter(Site==5) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=p)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="p(Occ)") 
```

```{r}
 allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Model,jPlant,Site,Month) %>% summarize(mean=mean(value)) %>% filter(Site==5) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=mean)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="Discrepancy") 
```

## 2300m - 2500m

```{r}
allchains %>% filter(parameter %in% "Ynew") %>% group_by(Model,jPlant,Site,Month) %>% summarize(p=sum(value)/n()) %>% filter(Site==6) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=p)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="p(Occ)") 
```

```{r}
 allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Model,jPlant,Site,Month) %>% summarize(mean=mean(value)) %>% filter(Site==6) %>% inner_join(jagsIndexPlants) %>% ggplot(.,aes(x=as.factor(Month),y=Plant)) + geom_tile(aes(fill=mean)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(fill="Discrepancy") 
```

## Alpha: Species specific flowering rate

```{r,fig.width=11,fig.height=6}
allchains %>% filter(parameter %in% "alpha") %>% ggplot(.,aes(fill=Model,x=value)) + geom_density(alpha=0.4) +  facet_wrap(~Plant,scales="free",ncol=3)

allchains %>% filter(parameter %in% "alpha") %>% ggplot(.,aes(fill=Model,x=inv.logit(value))) + geom_density(alpha=0.6) +  facet_wrap(~Plant,scales="free")
```

## Omega: The magnitude of the effect of autocorrelation on mean flowering occurrence

```{r}
allpars<-allchains %>% filter(!parameter %in% c("Ynew")) %>% group_by(Model,Plant,parameter) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))
```

```{r}
allpars %>% filter(parameter %in% "omega") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + coord_flip() + labs(y="Omega")
```

## Gamma: The variance of the effect of autocorrelation on mean flowering occurrence

```{r,fig.height=6,fig.width=7}
allpars %>% filter(parameter %in% "gamma") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + coord_flip() + labs(y="Gamma")
```

## Lambda: The decay in autocorrelation effect

```{r,fig.height=5,fig.width=7}
allpars %>% filter(parameter %in% "lambda_cov") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + coord_flip() + labs(y="lambda")
```

## Decay in autocorrelation effect

```{r}
phy_effect$Model<-"Phylogenetic Attraction"
phyrepulse_effect$Model<-"Phylogenetic Repulsion"
trait_effect$Model<-"Trait Attraction"
traitrepulse_effect$Model<-"Trait Repulsion"
intrepulse_effect$Model<-"Interaction Repulsion"
int_effect$Model<-"Interaction Attraction"

est_effect<-bind_rows(list(phy_effect,phyrepulse_effect,trait_effect,traitrepulse_effect,traitrepulse_effect,int_effect,intrepulse_effect))
ggplot(est_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance") + facet_wrap(~Model,scales="free",ncol=2)
```

# Model Fit

## Bayesian pvalue

```{r,fig.height=10,fig.width=10}
fitstat<-allchains %>% filter(parameter %in% c("fit","fitnew")) %>% select(Model,Effect,Draw,chain,parameter,value)  %>% spread(key=parameter,value=value) 

ymin<-min(fitstat$fit)
ymax<-max(fitstat$fit)
ab<-data.frame(x=seq(0,ymax,1),y=seq(0,ymax,1))

ggplot(data=fitstat,aes(x=fit,y=fitnew)) + geom_point(aes(col=Model)) + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data",col="Model")  + ggtitle("Posterior predictive check") + coord_fixed() + geom_abline()

#Bayesian p-value
fitstat %>% group_by(Model) %>% summarize(p=sum((fitnew>fit)/n()))
```

Without baseline
```{r,fig.height=10,fig.width=10}
fitstat<-allchains %>% filter(parameter %in% c("fit","fitnew"),!Model=="baseline") %>% select(Model,Effect,Draw,chain,parameter,value)  %>% spread(key=parameter,value=value) 

ymin<-min(fitstat$fit)
ymax<-max(fitstat$fit)
ab<-data.frame(x=seq(0,ymax,1),y=seq(0,ymax,1))

ggplot(data=fitstat,aes(x=fit,y=fitnew)) + geom_point(aes(col=Model)) + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data",col="Model")  + ggtitle("Posterior predictive check") + coord_fixed() + geom_abline()

#Bayesian p-value
fitstat %>% group_by(Model) %>% summarize(p=sum((fitnew>fit)/n()))
```

## Model Fit

```{r}
allchains %>% filter(parameter %in% "fit") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()

allchains %>% filter(parameter %in% "fit",!Model %in% "baseline") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(desc(mean)) %>% kable() %>% kable_styling()
```

### Without baseline

```{r}
allchains %>% filter(parameter %in% "fit",!Model %in% "baseline") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()
```

## By Species

```{r}
allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sum(value)/n()) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(mean) %>% ggplot(.,aes(x=Plant,y=mean,col=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()
```

### Without baseline

```{r}
allchains %>% filter(parameter %in% "discrepancy",!Model=="baseline") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sum(value)/n()) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(mean) %>% ggplot(.,aes(x=Plant,y=mean,col=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()
```

### Zoom in
```{r,fig.height=10,fig.width=12}
allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sum(value)/n()) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(mean) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + labs(y="Fit Error") + theme_bw() + facet_wrap(~Plant,ncol=3,scales="free") + coord_flip()
```

# Prediction

```{r}
allchains %>% filter(parameter %in% "fitpred") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Prediction Error") + theme_bw()
```

```{r}
allchains %>% filter(parameter %in% "pred_error") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sum(value)/n()) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(mean) %>% ggplot(.,aes(x=Plant,y=mean,col=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()
```

```{r}
allchains %>% filter(parameter %in% "pred_error") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sum(value)/n()) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(mean) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + labs(y="Prediction Error") + theme_bw() + facet_wrap(~Plant,ncol=3,scales="free") + coord_flip()
```

```{r}
allchains %>% filter(parameter %in% "fitpred") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Sum Prediction Error") + theme_bw() 
```

### Tables

```{r}
allchains %>% filter(parameter %in% "fitpred") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(desc(mean)) %>% kable() %>% kable_styling()
```

### Flowering Rates among models

```{r}
Ynewtable<-allchains %>% filter(parameter %in% "Ynew") %>% mutate(value=value) %>%  group_by(Model,Plant,Month) %>% summarize(n=round(sum(value)/n() * 100,1))  

pdat<-indat %>% group_by(Plant,Month) %>% filter(!Year==2017)%>% summarize(Observed=round(sum(n)/n() * 100,1)) %>% inner_join(Ynewtable) %>% mutate(Month=month.abb[as.numeric(Month)])

pdat %>% spread(Model,n)  %>% arrange(Plant,Month) %>% kable() %>% kable_styling()

ggplot(pdat,aes(x=Observed,y=n,col=Model)) + geom_point() + geom_abline() + labs(x="Observed flowering (%)",y="Predicted Flowering (%)") +coord_equal()

ggplot(pdat,aes(x=Observed,y=n,col=Model)) + geom_point() + geom_abline() + labs(x="Observed flowering (%)",y="Predicted Flowering (%)") + facet_wrap(~Month) + coord_equal(xlim = c(0,60),ylim=c(0,60)) 
```

# Flowering correlations in predictions

```{r,eval=T}

cormat<-function(dat){
  dat %>% select(-Model) %>% as.matrix(.) %>% cor(.) %>% reshape2::melt(.)
}

allchains %>% filter(parameter %in% "p") %>% group_by(Model,Plant,Site,Month) %>% summarize(p=mean(value)) %>% spread(Plant,p) %>% ungroup() %>% select(-Month,-Site) %>% group_by(Model) %>% do(cormat(.)) %>% ggplot(.,aes(x=Var1,y=Var2)) + geom_tile(aes(fill=value)) + facet_wrap(~Model) + scale_fill_continuous(low="blue",high="red") + labs(x="",y="",fill="r") + theme(axis.text.x=element_text(angle=-90))
```

```{r,fig.height=70}
allchains %>% filter(parameter %in% "e") %>% group_by(Model,Plant,Site,Month) %>% summarize(p=mean(value)) %>% spread(Plant,p) %>% ungroup() %>% select(-Month,-Site) %>% group_by(Model) %>% do(cormat(.)) %>% filter(!Var1==Var2) %>% ggplot(.,aes(x=Model,y=value)) + geom_point() + facet_wrap(Var1~Var2,ncol=4,scales = "free_x") + coord_flip()
```

```{r}
save.image("/Users/ben/Dropbox/Gesner/Phenology.RData")
```
