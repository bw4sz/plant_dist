---
title: "Co-flowering and hummingbird overlap in Neotropical Gesneriaceae: Predicting Phenology"
author: "Ben Weinstein"
date: "6/4/2018"
output: 
  html_document:
    toc: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r,message=F,warning=F,include=F}
library(knitr)
opts_chunk$set(message=F,warning=F,echo=F)
library(lubridate)
library(ape)
library(tidyr)
library(kableExtra)
library(boot)
library(dplyr)
library(ggplot2)
library(phytools)
library(stringr)
library(splines)
library(R2jags)
library(truncnorm)

#optionally load
#load("/Users/ben/Dropbox/Gesner/Phenology.RData")

#holder for models and chains
models<-list()
chains<-list()
discrepancy<-list()
```
# Transects
```{r}
#transects
transects<-read.csv("data/cleaned/transects.csv",row.names=1)
head(transects) %>% kable() %>% kable_styling()

#drop NA elevations
transects<-transects %>% filter(!is.na(ele))
```

# Phylogeny

```{r}
phy<-read.newick("data/SantaLucia_tree_Newick")
species<-str_match(phy$tip.label,"_(\\w+)")[,2]
tspecies<-unique(transects$Plant)
to_join<-data.frame(Plant=tspecies,phylo=str_match(tspecies," (\\w+)")[,2])
new_names<-data.frame(phylo=species) %>% inner_join(to_join)
phy$tip.label<- as.character(new_names$Plant)
plot(phy)

#variance covariance matrix - attraction
vcov<-vcv(phy,corr = T)

#variance covariance matrix - attraction
ivcov<-solve(vcov)

#Phylogenetic distance matrix
D<-as.matrix(cophenetic(phy))
D<-round(D/max(D),5)

#Identity matrix
I<-diag(nrow(vcov))

#match transects with phylogeny
transects<-transects %>% filter(Plant %in% phy$tip.label) %>% droplevels()
```

# Traits
```{r}
traits<-read.csv("data/Species_SantaLucia.csv")

#improve column names
traits<-traits %>% select(Plant=Iplant_Double,min_corolla_tube=Lt,corolla_length=Lc,vertical_diameter=D,stamen_length=S,stamen_exertion=E)

#match with phylogeny
traits<-traits %>% filter(Plant %in% phy$tip.label)

#order the factors
head(transects) %>% kable() %>% kable_styling()
```

### Total Flowers

```{r,fig.height=20,eval=F}
transects %>% group_by(Plant,Year) %>%
ggplot(.,aes(x=julian,y=Flowers,col=as.factor(Year))) + geom_point(size=0.1) + geom_line(aes(group=Year)) + facet_wrap(~Plant,scales="free",ncol=2) + labs(col="Year") + theme_bw()
```

## Peak date

```{r}
transects %>% group_by(Plant,Year) %>% filter(Flowers==max(Flowers)) %>% summarize(julian=mean(julian)) %>% arrange(Plant,Year) %>% ggplot(.,aes(x=Plant,y=julian,col=as.factor(Year))) + geom_point(size=3) + theme_bw() + coord_flip() + labs(x="Plant",y="Julian Day of Peak Flowering",col="Year") 
```

```{r,fig.height=10}
ggplot(data=transects) + geom_density(aes(x=julian,fill=Plant)) + facet_wrap(~Plant,ncol=3) + theme_bw()
```

## Infer absences

```{r,fig.height=15}
sumf<-transects %>% group_by(Plant,Date,julian,Year) %>% dplyr::summarize(n=n(),ele=mean(ele)) %>% mutate(Year=as.factor(Year))
zero_count<-expand.grid(Plant=unique(sumf$Plant),Date=unique(sumf$Date),n=0)

#merge elevation for 0 count, get's mean elevation of that day
mean_ele<-transects %>% group_by(Date) %>% summarize(ele=mean(ele))
zero_count<-zero_count %>% anti_join(sumf,by=c("Plant","Date")) %>% mutate(Year=chron::years(as.POSIXct(Date)),julian=yday(as.POSIXct(Date))) %>% inner_join(mean_ele)
transects_zero<-bind_rows(sumf,zero_count)

#transects_zero %>% group_by(Plant,Year) %>%
#ggplot(.,aes(x=as.numeric(julian),y=n,col=as.factor(Year))) + geom_point(size=0.1) + #geom_line(aes(group=as.factor(Year))) + facet_wrap(~Plant,scales="free",ncol=3) + labs(col="Year") + theme_bw()

transects_zero %>% group_by(Plant,Year)  %>% filter(!is.na(n)) %>%
ggplot(.,aes(x=julian,y=n,col=as.factor(Year))) + geom_point(size=2)+  facet_wrap(~Plant,scales="free",ncol=3) + labs(col="Year") + theme_bw()
```

## Species elevation ranges

```{r}
ggplot(transects_zero %>% filter(!n==0),aes(x=Plant,y=ele)) + geom_boxplot() + coord_flip()
```

#Count model of species phenology

```{r,fig.height=15}
#prepare data
indat<-transects_zero

#Easiest to work with jags as numeric ordinal values
indat$Plant<-as.factor(indat$Plant)
indat$jPlant<-as.numeric(indat$Plant)

jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=factor(1:length(levels(indat$Plant))))

#hold 2017 data aside for prediction
to_predict<-indat %>% filter(Year %in% "2017")
indat<-indat %>% filter(!Year %in% "2017")

#give index positions
to_predict$Index<-1:nrow(to_predict)
indat$Index<-1:nrow(indat)
```

```{r}
#Source model
source("model/poisson_occ_elev.R")

#print model
writeLines(readLines("model/poisson_occ_elev.R"))

#Run Model
runModel<-function(Yobs_dat,Ynew_dat){
  
  #Parameters to track
  ParsStage <- c("alpha","fit","fitnew","discrepancy","fitpred","beta","Ynew","prediction","alpha2")
  
  InitStage<-function(){
    list(
      z=rep(0,length(Yobs_dat$n)),
      z_new=rep(0,length(Ynew_dat$n))
    )
  }
  
  #Jags Data

  Dat<-list(
    
    #Observed data
    Y=Yobs_dat$n,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$n),
    ele=Yobs_dat$ele,
    
    #Prediction data
    Ypred=Ynew_dat$n,
    Ypred_plant=Ynew_dat$jPlant,
    ele_new=Ynew_dat$ele,
    Npreds=length(Ynew_dat$n))
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,inits = InitStage,model.file="model/poisson_occ_elev.jags",n.thin=1,n.iter=1000,n.burnin=900,n.chains=2,DIC=F)
    )
    return(model)
}

models$julian<-runModel(Yobs_dat=indat,Ynew_dat=to_predict)
```

```{r} 
getChains<-function(mod,indat,to_predict){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha","beta")]<-lapply(
    splitpc[c("alpha","beta")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
  
  #ragged index - observed
  splitpc[c("discrepancy","Ynew")]<-lapply(
    splitpc[c("discrepancy","Ynew")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with indat to get species
    ragged<-sv %>% left_join(indat[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  
    #ragged index - prediction
  splitpc[c("prediction")]<-lapply(
    splitpc[c("prediction")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with indat to get species
    ragged<-sv %>% left_join(to_predict[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$julian<-getChains(models$julian,indat,to_predict) %>% left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$julian %>% filter(parameter %in% c("alpha","beta")) %>%                    ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$julian %>% filter(parameter %in% c("fit","fitnew","fitpred")) %>%                    ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=1) + labs(col="chain")
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$julian %>% filter(parameter %in% c("alpha","fit","fitnew","fitpred")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=1,scales="free")
```

### Estimated occurrence

Red is the kernel density from the underlying data
Black is the modeled phenology

```{r,fig.height=11}

preds<-chains$julian %>% filter(parameter %in% c("Ynew")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=indat,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

### Predicted occurrence

```{r,fig.height=11}
preds<-chains$julian %>% filter(parameter %in% c("prediction")) %>% group_by(Plant,Index)
ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=to_predict,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

# Phylogeny

## Attraction

```{r,fig.height=15}
#prepare data
indat<-transects_zero %>% filter(Plant %in% phy$tip.label)
indat$Plant<-factor(indat$Plant,levels=phy$tip.label)
indat$jPlant<-as.numeric(indat$Plant)
jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=factor(1:length(levels(indat$Plant))))

#hold 2017 data aside for prediction
to_predict<-indat %>% filter(Year %in% "2017")
indat<-indat %>% filter(!Year %in% "2017")

#give index positions
to_predict$Index<-1:nrow(to_predict)
indat$Index<-1:nrow(indat)
```

```{r}
#Source model
source("model/poisson_occ_elev_attraction.R")

#print model
writeLines(readLines("model/poisson_occ_elev_attraction.R"))

#Run Model
runModel_attraction<-function(Yobs_dat,Ynew_dat,D=D){
  
  
  #Parameters to track
  ParsStage <- c("alpha","fit","fitnew","discrepancy","lambda_cov","e","omega","fitpred","beta","Ynew","prediction","gamma")
  
  #Jags Data

  Dat<-list(
    Y=Yobs_dat$n,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$n),
    zeros=rep(0,max(c(Yobs_dat$jPlant))),
    ele=Yobs_dat$ele,
    D=D,
    I=I,
    
    #Prediction data
    Ypred=Ynew_dat$n,
    Ypred_plant=Ynew_dat$jPlant,
    ele_new=Ynew_dat$ele,
    Npreds=length(Ynew_dat$n))
  
    InitStage<-function(){
    list(
      z=rep(0,length(Yobs_dat$n)),
      z_new=rep(0,length(Ynew_dat$n))
    )
    }
    
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,inits = InitStage,model.file="model/poisson_occ_elev_attraction.jags",n.thin=1,n.iter=1000,n.burnin=900,n.chains=2,DIC=F)
    )
    return(model)
}

models$phylogenetic_attraction<-runModel_attraction(Yobs_dat=indat,Ynew_dat=to_predict,D=D)
```

#Get Chains
```{r} 
getChains<-function(mod,indat,to_predict){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("e","beta")]<-lapply(
    splitpc[c("e","beta")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
  
  #ragged index - observed
  splitpc[c("discrepancy","Ynew")]<-lapply(
    splitpc[c("discrepancy","Ynew")],function(x){
    #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with observed data to get species
    ragged<-sv %>% left_join(indat[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  
  #ragged index - predicted
  splitpc[c("prediction")]<-lapply(
    splitpc[c("prediction")],function(x){
    
      #get index
    sv<-data.frame(Index=as.numeric(str_match(x$par,"(\\w+)\\[(\\d+)]")[,3]))
    
    #merge with predicted data to get species
    ragged<-sv %>% left_join(to_predict[,c("Index","jPlant")]) %>% mutate(jPlant=as.character(jPlant))
    
    pc<-data.frame(x,ragged)
    return(pc)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r}
chains$phylogenetic_attraction<-getChains(models$phylogenetic_attraction,indat,to_predict) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$phylogenetic_attraction %>% filter(parameter %in% c("alpha","e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$phylogenetic_attraction %>% filter(parameter %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>%  ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$phylogenetic_attraction %>% filter(!parameter %in% c("discrepancy","Ynew","prediction")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Estimated Occurrence

```{r,fig.height=11}
preds<-chains$phylogenetic_attraction %>% filter(parameter %in% c("Ynew")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=indat,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Predicted Phenology

```{r,fig.height=11}
preds<-chains$phylogenetic_attraction %>% filter(parameter %in% c("prediction")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=to_predict,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Decay in phylogenetic attraction

```{r}

effect<-function(lambda,D){
  y<-as.numeric(exp(-lambda*D))
  data.frame(lambda,Distance=as.numeric(D),Covariance=y)
}

phy_effect<-chains$phylogenetic_attraction %>% filter(parameter=="lambda_cov") %>% group_by(Draw,chain) %>% do(effect(.$value,D)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(phy_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Phylogenetic Covariance")
```

## Repulsion

```{r}
#Source model
source("model/poisson_occ_elev_repulsion.R")

#print model
writeLines(readLines("model/poisson_occ_elev_repulsion.R"))

#Run Model
runModel_repulsion<-function(Yobs_dat,Ynew_dat,D=D){
  
  
  #Parameters to track
  ParsStage <- c("alpha","beta","fit","fitnew","discrepancy","lambda_cov","e","omega","fitpred","Ynew","prediction","gamma")
  
  #Jags Data

  Dat<-list(
    Y=Yobs_dat$n,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$n),
    zeros=rep(0,max(c(Yobs_dat$jPlant))),
    D=D,
    ele=Yobs_dat$ele,
    I=I,
    
    #Prediction data
    Ypred=Ynew_dat$n,
    Ypred_plant=Ynew_dat$jPlant,
    ele_new=Ynew_dat$ele,
    Npreds=length(Ynew_dat$n))
  
      InitStage<-function(){
    list(
      z=rep(0,length(Yobs_dat$n)),
      z_new=rep(0,length(Ynew_dat$n))
    )
      }
      
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,inits=InitStage,model.file="model/poisson_occ_elev_repulsion.jags",n.thin=1,n.iter=1000,n.burnin=900,n.chains=2,DIC=F)
    )
    return(model)
}

models$phylogenetic_repulsion<-runModel_repulsion(Yobs_dat=indat,Ynew_dat=to_predict,D=D)
```

#Get Chains

```{r}
chains$phylogenetic_repulsion<-getChains(models$phylogenetic_repulsion,indat,to_predict) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$phylogenetic_repulsion %>% filter(parameter %in% c("alpha","e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$phylogenetic_repulsion %>% filter(par %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$phylogenetic_repulsion %>% filter(!parameter %in% c("discrepancy","Ynew","prediction")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Estimated Phenology

```{r,fig.height=11}
preds<-chains$phylogenetic_repulsion %>% filter(parameter %in% c("Ynew")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=indat,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Predicted Phenology

```{r,fig.height=11}
preds<-chains$phylogenetic_repulsion %>% filter(parameter %in% c("prediction")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=to_predict,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Decay in phylogenetic repulsion

```{r}

effect_repulsion<-function(lambda,D){
  y<-as.numeric(solve(exp(-lambda*D)))
  data.frame(lambda,Distance=as.numeric(D),Covariance=y)
}

phyrepulse_effect<-chains$phylogenetic_repulsion %>% filter(parameter=="lambda_cov") %>% group_by(Draw,chain) %>% do(effect_repulsion(.$value,D)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(phyrepulse_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

# Traits

## Trait Attraction

```{r}
#Distance matrix
rownames(traits)<-traits[,1]
Dtraits<-as.matrix(dist(traits[,-1]))
Dtraits<-Dtraits/max(Dtraits)

#filter data to match traits
indat<-transects_zero%>% filter(Plant %in% rownames(traits))
indat$Plant<-factor(indat$Plant,levels=rownames(traits))
indat$jPlant<-as.numeric(indat$Plant)
jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=factor(1:length(levels(indat$Plant))))

#hold 2017 data aside for prediction
to_predict<-indat %>% filter(Year %in% "2017")
indat<-indat %>% filter(!Year %in% "2017")

#give index positions
to_predict$Index<-1:nrow(to_predict)
indat$Index<-1:nrow(indat)
```

```{r}
#Source model
source("model/poisson_occ_elev_attraction.R")

#print model
writeLines(readLines("model/poisson_occ_elev_attraction.R"))

models$trait_attraction<-runModel_attraction(Yobs_dat=indat,Ynew_dat=to_predict,D=Dtraits)
```

#Get Chains

```{r}
chains$trait_attraction<-getChains(models$trait_attraction,indat,to_predict) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$trait_attraction %>% filter(parameter %in% c("alpha","e","beta")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$trait_attraction %>% filter(par %in% c("fit","fitnew","lambda_cov","fitpred","omega","gamma")) %>%  ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$trait_attraction %>% filter(!parameter %in% c("discrepancy","Ynew","prediction")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Estimated Phenology

```{r,fig.height=11}
preds<-chains$trait_attraction %>% filter(parameter %in% c("Ynew")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=indat,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Predicted Phenology

```{r,fig.height=11}
preds<-chains$trait_attraction %>% filter(parameter %in% c("prediction")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=to_predict,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Decay in trait attraction

```{r}
trait_effect<-chains$trait_attraction %>% filter(parameter=="lambda_cov") %>% group_by(Draw,chain) %>% do(effect(.$value,Dtraits)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(trait_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

## Repulsion

```{r}
#Source model
source("model/poisson_occ_elev_repulsion.R")

#print model
writeLines(readLines("model/poisson_occ_elev_repulsion.R"))

models$trait_repulsion<-runModel_repulsion(Yobs_dat=indat,Ynew_dat=to_predict,D=Dtraits)
```

#Get Chains

```{r}
chains$trait_repulsion<-getChains(models$trait_repulsion,indat,to_predict) %>%  left_join(jagsIndexPlants)
```

### Evaluate convergence

```{r,fig.height=12,fig.width=15}
chains$trait_repulsion %>% filter(parameter %in% c("alpha","e")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_grid(parameter~Plant,scales="free")
```

```{r}
chains$trait_repulsion %>% filter(par %in% c("fit","fitnew","lambda_cov","omega","fitpred","gamma")) %>% ggplot(.,aes(x=Draw,col=as.factor(chain),y=value)) + geom_line() + facet_wrap(~parameter,scales="free",ncol=2)
```

### Posterior estimates
```{r,fig.height=10,fig.width=10}
chains$trait_repulsion %>% filter(!parameter %in% c("discrepancy","Ynew","prediction")) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~parameter,ncol=2,scales="free")
```

## Estimated Occurrence

```{r,fig.height=11}
preds<-chains$trait_repulsion %>% filter(parameter %in% c("Ynew")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3)+ labs(x="Flowering Plants",y="Density") + geom_density(data=indat,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Predicted Occurrence

```{r,fig.height=11}
preds<-chains$trait_repulsion %>% filter(parameter %in% c("prediction")) %>% group_by(Plant,Index)

ggplot(preds) + geom_density(fill="black",aes(x=value)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Flowering Plants",y="Density") + geom_density(data=to_predict,aes(x=n),alpha=0.5,fill="red") + theme_bw()
```

## Decay in trait repulsion

```{r}
traitrepulse_effect<-chains$trait_repulsion %>% filter(parameter=="lambda_cov") %>% group_by(Draw,chain) %>% do(effect_repulsion(.$value,Dtraits)) %>% group_by(Distance) %>% filter(!Distance==0) %>% summarize(mean=mean(Covariance),lower=quantile(Covariance,0.05),upper=quantile(Covariance,0.95))

ggplot(traitrepulse_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance")
```

# Model Comparison

```{r}
#reduce models to a single df
for(x in 1:length(chains)){
  chains[[x]]$Model<-names(chains)[[x]]
}

allchains<-bind_rows(chains)

#create an attraction/repulsion label
allchains$Effect<-str_detect(allchains$Model,"repulsion")

allchains[!allchains$Effect==TRUE,"Effect"]<-"Attraction"
allchains[allchains$Effect==TRUE,"Effect"]<-"Repulsion"
allchains[allchains$Model=="julian","Effect"]<-NA
```

## Alpha

```{r}
allpars<-allchains %>% filter(!parameter %in% c("discrepancy")) %>% group_by(Model,Plant,parameter) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

#Alphas
allpars %>% filter(parameter %in% "alpha") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + coord_flip()
```

## E: The effect of autocorrelation on mean flowering intensity

```{r,fig.height=12,fig.width=10}
allpars %>% filter(parameter %in% "e") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + facet_wrap(~Plant,scales="free",ncol=3) + coord_flip() + labs(y="E")
```

## Omega: The magnitude of the effect of autocorrelation on mean flowering intensity

```{r}
allpars %>% filter(parameter %in% "omega") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + coord_flip() + labs(y="Omega")
```

## Gamma: The variance of the effect of autocorrelation on mean flowering intensity

```{r,fig.height=12,fig.width=10}
allpars %>% filter(parameter %in% "gamma") %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + coord_flip() + labs(y="Gamma")
```

## Beta: The effect of elevation on flowering presence

Still TODO

To make the graph interesting, take the difference in the minimum elevation and the max elevation and express the effect in days


```{r,fig.height=12,fig.width=10}

daydiff<-function(beta){
  
  min_ele<-min(transects$ele)
  max_ele<-max(transects$ele)
  
  days=(max_ele*beta) - (min_ele*beta)
  
  return(data.frame(beta,days))
  
}

allchains %>% filter(parameter %in% "beta") %>% group_by(Model,Plant) %>% do(daydiff(.$value)) %>% summarize(mean=mean(days),lower=quantile(days,0.05),upper=quantile(days,0.95)) %>% ggplot(.,aes(x=Model,y=mean)) + geom_pointrange(aes(ymin=lower,ymax=upper)) + facet_wrap(~Plant,scales="free",ncol=3) + coord_flip() + labs(y="Days difference in flowering intensity along elevation gradient")
```

## Estimated Inensity

```{r,fig.height=10,fig.width=12}
preds<-allchains %>% filter(parameter %in% c("Ynew")) %>% group_by(Model,Plant,Index)

ggplot(preds) + geom_density(aes(x=value,fill=Model),alpha=0.2) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Intensity",y="Density") + geom_density(data=indat,aes(x=n),size=1.2) + theme_bw()
```

## Effect of autocorrelation

```{r}
autocorrelation<-allchains %>% select(-par) %>% filter(parameter %in% "e")  %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95))

ggplot(autocorrelation) + geom_pointrange(aes(x=Plant,ymin=lower,ymax=upper,y=mean,col=Model))+ coord_flip() + labs(y="Effect on intensity")
```

## Decay in autocorrelation effect

```{r}
phy_effect$Model<-"Phylogenetic Attraction"
phyrepulse_effect$Model<-"Phylogenetic Repulsion"
trait_effect$Model<-"Trait Attraction"
traitrepulse_effect$Model<-"Trait Repulsion"

est_effect<-bind_rows(list(phy_effect,phyrepulse_effect,trait_effect,traitrepulse_effect))
ggplot(est_effect,aes(x=Distance,y=mean)) + geom_line() + geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.5) + theme_bw() + labs(x="Distance",y="Covariance") + facet_wrap(~Model,scales="free")
```

# Model Fit

## Bayesian pvalue

```{r,fig.height=10,fig.width=10}

fitstat<-allchains %>% filter(parameter %in% c("fit","fitnew")) %>% select(Model,Effect,Draw,chain,parameter,value)  %>% spread(key=parameter,value=value) 

ymin<-min(fitstat$fit)
ymax<-max(fitstat$fit)
ab<-data.frame(x=seq(0,ymax,1),y=seq(0,ymax,1))

ggplot(data=fitstat,aes(x=fit,y=fitnew)) + geom_point(aes(col=Model)) + theme_bw() + labs(x="Discrepancy of observed data",y="Discrepancy of replicated data",col="Model")  + ggtitle("Posterior predictive check") + coord_fixed() + geom_line(data=ab,aes(x=x,y=y),group=1,linetype="dashed") 

#Bayesian p-value
fitstat %>% group_by(Model) %>% summarize(p=sum((fitnew>fit)/n()))
```

## Overall

```{r}
allchains %>% filter(parameter %in% "fit") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()
```

## By Species

```{r}
allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sqrt(sum(value)/n())) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(mean) %>% ggplot(.,aes(x=Plant,y=mean,col=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Discrepancy") + theme_bw()
```

Zoom in 
```{r,fig.height=10,fig.width=12}
allchains %>% filter(parameter %in% "discrepancy") %>% group_by(Draw,chain,Model,Plant) %>% summarize(value=sqrt(sum(value)/n())) %>% group_by(Model,Plant) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% arrange(mean) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + labs(y="Root Mean Squared Error") + theme_bw() + facet_wrap(~Plant,ncol=3,scales="free") + coord_flip()
```
#Prediction

```{r}
allchains %>% filter(parameter %in% "fitpred") %>% mutate(value=value) %>%  group_by(Model) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(y=mean,x=Model)) + geom_pointrange(aes(ymin=lower,ymax=upper),alpha=0.5,position=position_dodge(width=0.4)) + coord_flip() + labs(y="Root Mean Squared Error") + theme_bw()
```

## Out of sample data

```{r,fig.height=11,fig.width=12}
preds<-allchains %>% filter(parameter %in% c("prediction")) %>% group_by(Model,Plant,Index)

ggplot(preds) + geom_density(aes(x=value,fill=Model)) + facet_wrap(~Plant,scales="free",ncol=3) + labs(x="Julian Day",y="Density") + geom_density(data=to_predict,aes(x=n),alpha=0.5,fill="black") + theme_bw()
```

```{r}
save.image("/Users/ben/Dropbox/Gesner/Phenology.RData")
```
