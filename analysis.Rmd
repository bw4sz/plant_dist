---
title: "Co-flowering and hummingbird overlap in Neotropical Gesneriaceae: Phylogeny and Interactions"
author: "Ben Weinstein"
date: "5/30/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r,message=F,warning=F}
library(knitr)
opts_chunk$set(message=F,warning=F,echo=F)

library(ape)
library(kableExtra)
library(boot)
library(dplyr)
library(ggplot2)
library(phytools)
library(stringr)
library(splines)
library(R2jags)
library(reshape2)
library(tidyr)
```

# Interactions

```{r}

#Interactions
interactions<-read.csv("data/cleaned/interactions.csv",row.names=1)
head(interactions) %>% kable() %>% kable_styling()
```

# Phylogeny

```{r}
phy<-read.newick("data/SantaLucia_tree_Newick")
species<-str_match(phy$tip.label,"_(\\w+)")[,2]
tspecies<-unique(interactions$Plant)
to_join<-data.frame(Plant=tspecies,phylo=str_match(tspecies," (\\w+)")[,2])
new_names<-data.frame(phylo=species) %>% inner_join(to_join)
phy$tip.label<- as.character(new_names$Plant)
plot(phy)

#variance covariance matrix
vcov<-vcv(phy,corr = T)

#Identity matrix
I<-diag(nrow(vcov))
```

# Traits
```{r}
traits<-read.csv("data/Species_SantaLucia.csv")

#improve column names
traits<-traits %>% select(Plant=Iplant_Double,min_corolla_tube=Lt,corolla_length=Lc,vertical_diameter= D,stamen_length=S,stamen_exertion=E)

#order the factors

head(traits) %>% kable() %>% kable_styling()
```

Sum interaction matrix plotted in plant phylogenetic order.

```{r}
m<-interactions %>% filter(Plant %in% phy$tip.label) %>% group_by(Hummingbird,Plant) %>% summarize(n=n())
m$Plant<-factor(m$Plant,levels=phy$tip.label)
ggplot(m,aes(x=Hummingbird,y=Plant,fill=n)) + geom_tile() + theme_bw() + theme(axis.text.x=element_text(angle=-90))
```

# Estimate interaction probability

The goal is to generate a distance matrix of mean niche overlap among plants.

```{r}
ggplot(m,aes(x=Hummingbird,y=Plant,fill=n>0)) + geom_tile() + theme_bw() + theme(axis.text.x=element_text(angle=-90))
```

```{r}
#Convert to binary daily sampling
dailydat<-interactions %>% group_by(ID,Date,ele,Plant,Hummingbird) %>% summarize(n=n()) %>% mutate(Yobs=(n>0)*1) %>% select(-n)
```

```{r}
#Impute non-detections. Start by assuming all hummingbirds occur at all elevations (can be relaxed)

sumf<-dailydat %>% group_by(Plant,ID,Date,ele) %>% dplyr::summarize(n=n())

#Create emptys zeros
impute_zero<-function(x,Hummingbird){
  df<-data.frame(Hummingbird=Hummingbird)
}

zero_count<-sumf %>% group_by(Plant,ID,Date,ele) %>% do(impute_zero(.,Hummingbird=levels(dailydat$Hummingbird)))
zero_count<-zero_count %>% anti_join(dailydat)

#add a dummy label for presence absence
indat<-bind_rows(data.frame(dailydat),data.frame(zero_count,Yobs=0))
```

```{r}

#align factors with phylogeny
indat<-indat %>% filter(Plant %in% phy$tip.label)

#Easiest to work with jags as numeric ordinal values
indat$Hummingbird<-as.factor(indat$Hummingbird)
indat$Plant<-factor(indat$Plant,levels=phy$tip.label)
indat$jBird<-as.numeric(indat$Hummingbird)
indat$jPlant<-as.numeric(indat$Plant)

jagsIndexBird<-data.frame(Hummingbird=levels(indat$Hummingbird),jBird=factor(1:length(levels(indat$Hummingbird))))
jagsIndexPlants<-data.frame(Plant=levels(indat$Plant),jPlant=factor(1:length(levels(indat$Plant))))

indat$Index<-1:nrow(indat)
indat<-droplevels(indat)

#Turn Time and ID into numeric indexes
indat$jTime<-as.numeric(as.factor(indat$Date))
indat$jID<-as.numeric(as.factor(indat$ID))

```

```{r}
#hold model objects
models<-list()
chains<-list()
```

```{r}
#Source model
source("model/intercept_interactions.R")

#print model
writeLines(readLines("model/intercept_interactions.R"))

#Run Model
runModel<-function(Yobs_dat){
  
  #Parameters to track
  ParsStage <- c("alpha")
  
  #Jags Data

  Dat<-list(
    Yobs=Yobs_dat$Yobs,
    Birds=max(c(Yobs_dat$jBird)),
    Bird=Yobs_dat$jBird,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$Yobs))
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/intercept_interactions.jags",n.thin=1,n.iter=10,n.burnin=0,n.chains=2,DIC=F)
    )
    return(model)
}

models$intercept<-runModel(Yobs_dat=indat)
```

View Chains
```{r}
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha")]<-lapply(
    splitpc[c("alpha")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)]"))[,3:4]
    colnames(sv)<-c("jBird","jPlant")
    pc<-data.frame(x,sv)
    })
  
  chains<-bind_rows(splitpc)
return(chains)}
```

## Alpha

```{r,fig.height=8,fig.width=12}
chains$intercept<-getChains(models$intercept)

#merge species names
chains$intercept<-chains$intercept %>% left_join(jagsIndexBird) %>% left_join(jagsIndexPlants)

#alpha
chains$intercept %>% filter(parameter %in% "alpha",jPlant %in% c(5,10)) %>% ggplot(.,aes(x=inv.logit(value),fill=Plant)) + geom_histogram() + facet_wrap(~Hummingbird,scales="free")
```

```{r,fig.height=8,fig.width=8}
chains$intercept %>% filter(parameter %in% "alpha") %>% group_by(Hummingbird,Plant) %>% summarize(n=mean(value)) %>% ggplot(.,aes(fill=inv.logit(n),x=Plant,y=Hummingbird)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + theme(axis.text.x = element_text(angle=-90)) + labs(fill="P(Interaction)")
```

# Incomplete Detection

There is a fixed probability of interactions among species, but our ability to observe this state is variable based on hummingbird species (e.g. differences in abundance).

## Additional elevation information

```{r}
elev_zero<-read.csv("data/elevationdata.csv",row.names = 1)

#Easiest to work with jags as numeric ordinal values
elev_zero$Hummingbird<-as.factor(elev_zero$Hummingbird)
elev_zero$jBird<-as.numeric(elev_zero$Hummingbird)
```

```{r}
#Source model
source("model/intercept_interactions_detection.R")

#print model
writeLines(readLines("model/intercept_interactions_detection.R"))

#Run Model
runModel<-function(Yobs_dat,elev_data){
  
  #Parameters to track
  ParsStage <- c("alpha","omega","beta","alpha_elev","z")
  
  InitStage <- function(){
    list(
      z=array(dim=c(Dat$Birds,Dat$Plants,Dat$Cameras),data=1),
      occ=array(dim=c(Dat$Birds,Dat$Plants,Dat$Cameras),data=1)
    )
  }
  
  #Jags Data

  Dat<-list(
    Yobs=Yobs_dat$Yobs,
    Birds=max(c(Yobs_dat$jBird)),
    Bird=Yobs_dat$jBird,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Camera=Yobs_dat$jTime,
    Cameras=max(Yobs_dat$jTime),
    ele=indat %>% group_by(jTime) %>% summarize(ele=mean(ele)) %>% .$ele,
    Nobs=length(Yobs_dat$Yobs),
    
    #Elevation Ranges
    NElev_Obs=length(elev_data$Yobs),
    Elev_Bird=elev_data$jBird,
    Elev_ele=elev_data$ele,
    Elev_Y=elev_data$Yobs)
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,inits = InitStage, parameters.to.save=ParsStage,model.file="model/intercept_interactions_detection.jags",n.thin=1,n.iter=1000,n.burnin=900,n.chains=2,DIC=F)
    )
    return(model)
}

models$intercept<-runModel(Yobs_dat=indat,elev_data=elev_zero)
```

View Chains

```{r}
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
    #single index
  splitpc[c("omega","beta","alpha_elev")]<-lapply(
    splitpc[c("omega","beta","alpha_elev")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jBird=sv)
    })
  
  #double index
  splitpc[c("alpha")]<-lapply(
    splitpc[c("alpha")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)]"))[,3:4]
    colnames(sv)<-c("jBird","jPlant")
    pc<-data.frame(x,sv)
    })
  
    #double index
  splitpc[c("z")]<-lapply(
    splitpc[c("z")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)]"))[,3:5]
    colnames(sv)<-c("jBird","jPlant","jCamera")
    pc<-data.frame(x,sv)
    })
  chains<-bind_rows(splitpc)
return(chains)}
```

```{r,fig.height=8,fig.width=12}
chains$intercept<-getChains(models$intercept)

#merge species names
chains$intercept<-chains$intercept %>% left_join(jagsIndexBird) %>% left_join(jagsIndexPlants)

#alpha
chains$intercept %>% filter(parameter %in% "alpha",jPlant %in% c(5,10)) %>% ggplot(.,aes(x=value,fill=Plant)) + geom_histogram() + facet_wrap(~Hummingbird,scales="free")

chains$intercept %>% filter(parameter %in% "omega") %>% ggplot(.,aes(x=value,fill=as.factor(chain))) + geom_density() + facet_wrap(~Hummingbird,scales="free") + labs(fill="Chain")

chains$intercept %>% filter(parameter %in% "beta") %>% ggplot(.,aes(x=value,fill=as.factor(chain))) + geom_density() + facet_wrap(~Hummingbird,scales="free") + labs(fill="Chain")

```

### P(Occurrence)

```{r}
sim_elevation<-function(alpha,beta,ele){
  pelev<-inv.logit(alpha + beta * ele)
  data.frame(ele,value=pelev)
}

chains$intercept %>% filter(parameter %in% c("alpha_elev","beta")) %>% select(-par) %>% spread(parameter,value) %>% group_by(Hummingbird,Draw,chain) %>% do(sim_elevation(alpha=.$alpha_elev,beta =.$beta ,ele=unique(indat$ele))) %>% group_by(Hummingbird,ele) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(x=ele)) + geom_ribbon(aes(ymin=lower,ymax=upper)) + geom_line(aes(y=mean),col="Red",linetype="dashed")+ labs(y="Occurrence Probability") + facet_wrap(~Hummingbird)
```

### P(Detection)

```{r}
chains$intercept %>% filter(parameter %in% c("omega")) %>% group_by(Hummingbird) %>% summarize(mean=mean(value),lower=quantile(value,0.05),upper=quantile(value,0.95)) %>% ggplot(.,aes(x=ele)) + geom_pointrange(aes(x=Hummingbird,ymin=lower,ymax=upper,y=mean)) + labs(y="Detection Probability") + coord_flip()
```

Compared to observations

```{r}
ggplot(indat,aes(x=ele,y=Yobs)) + geom_point() + facet_wrap(~Hummingbird) + stat_smooth(method="glm",method.args=list(family="binomial"))
```

### P(Interaction)

```{r,fig.height=8,fig.width=8}
chains$intercept %>% filter(parameter %in% "alpha") %>% group_by(Hummingbird,Plant) %>% summarize(n=mean(value)) %>% ggplot(.,aes(fill=n,x=Plant,y=Hummingbird)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + theme(axis.text.x = element_text(angle=-90)) + labs(fill="P(Interaction)") + scale_fill_gradient2(low="blue",mid="white",high="Red",midpoint=0.5,limits=c(0,1))
```

# Niche Overlap

#Phylogenetic model of species interactions

Do plants show phylogenetic signal in hummingbird partners?

Start with binary interactions

```{r}
#Source model
source("model/intercept_phylogeny.R")

#print model
writeLines(readLines("model/intercept_phylogeny.R"))

#Run Model
runModel<-function(Yobs_dat,I,vcov){
  
  
  #Parameters to track
  ParsStage <- c("alpha","lambda","sigma","e","tauC")
  
  #Jags Data


  Dat<-list(
    Yobs=Yobs_dat$Yobs,
    Birds=max(c(Yobs_dat$jBird)),
    Bird=Yobs_dat$jBird,
    Plant=Yobs_dat$jPlant,
    Plants=max(c(Yobs_dat$jPlant)),
    Nobs=length(Yobs_dat$Yobs),
    I=I,
    vcov=vcov,
    zeros=rep(0,max(c(Yobs_dat$jPlant))))
  
  #MCMC options
    system.time(
      model<-jags(data=Dat,parameters.to.save=ParsStage,model.file="model/intercept_phylogeny.jags",n.thin=1,n.iter=50000,n.burnin=49000,n.chains=2,DIC=F)
    )
    return(model)
}

models$intercept<-runModel(Yobs_dat=indat,I=I,vcov=vcov)
```

#Get Chains
```{r}
getChains<-function(mod){
  
  pc<-reshape2::melt(mod$BUGSoutput$sims.array)
  colnames(pc)<-c("Draw","chain","par","value")
  
  #extract parameter name
  pc$parameter<-data.frame(str_match(pc$par,"(\\w+)"))[,-1]
  
  #Extract index
  splitpc<-split(pc,pc$parameter)
  
  #single index
  splitpc[c("alpha","tauC")]<-lapply(
    splitpc[c("alpha","tauC")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+),(\\d+)]"))[,3:4]
    colnames(sv)<-c("jBird","jPlant")
    pc<-data.frame(x,sv)
    })
  
    splitpc[c("e")]<-lapply(
    splitpc[c("e")],function(x){
    sv<-data.frame(str_match(x$par,"(\\w+)\\[(\\d+)]"))[,3]
    pc<-data.frame(x,jPlant=sv)
    })
    
  chains<-bind_rows(splitpc)
return(chains)}
```

## Alpha

The probability of interactions among hummingbirds and plants

Grab 1 species to visualize

```{r,fig.height=8,fig.width=8}
chains$intercept<-getChains(models$intercept)

#merge species names
chains$intercept<-chains$intercept %>% left_join(jagsIndexBird) %>% left_join(jagsIndexPlants)

#alpha
chains$intercept %>% filter(parameter %in% "alpha",jPlant %in% c(5,10)) %>% ggplot(.,aes(x=inv.logit(value),fill=Plant)) + geom_histogram() + facet_wrap(~Hummingbird,scales="free")
```

```{r,fig.height=8,fig.width=8}
chains$intercept %>% filter(parameter %in% "alpha") %>% group_by(Hummingbird,Plant) %>% summarize(n=mean(value)) %>% ggplot(.,aes(fill=inv.logit(n),x=Plant,y=Hummingbird)) + geom_tile() + scale_fill_continuous(low="blue",high="red") + theme(axis.text.x = element_text(angle=-90)) + labs(fill="P(Interaction)")
```

## Lambda

The phylogenetic signal in interaction probability

```{r}
chains$intercept %>% filter(parameter %in% "lambda") %>% ggplot(.,aes(x=Draw,y=value,col=as.factor(chain))) + geom_line() 

chains$intercept %>%  filter(parameter %in% "lambda") %>% ggplot(.,aes(x=value,fill=par)) + geom_histogram()

```

## sigma

The variance phylogenetic signal in interaction probability

```{r}
chains$intercept %>% filter(parameter %in% "sigma") %>% ggplot(.,aes(x=Draw,y=value,col=as.factor(chain))) + geom_line() 

chains$intercept %>%  filter(parameter %in% "sigma") %>% ggplot(.,aes(x=value,fill=par)) + geom_histogram()
```

# e

This can be thought of as the effect size of phylogenetic influence. Change in probability of interactions due to interactions

```{r}
chains$intercept %>%  filter(parameter %in% "e") %>% ggplot(.,aes(fill=Plant,x=inv.logit(value))) + geom_histogram() + labs(fill="Probability of interactions")
```


```{r}
save.image("/Users/ben/Dropbox/Gesner/analysis.RData")
```
